/*********************************************************************************
 * File: main.c
 * Author: Tinghui Wang
 *
 * Copyright @ 2017 RealDigital.org
 *
 * Description:
 *   Audio test for speaker and mic loopback.
 *
 * History:
 *   11/13/17: Created
 *
 * License: BSD 3-Clause
 *
 * Redistribution and use in source and binary forms, with or without 
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this 
 *    list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice, 
 *    this list of conditions and the following disclaimer in the documentation 
 *    and/or other materials provided with the distribution.
 *
 * 3. Neither the name of the copyright holder nor the names of its contributors 
 *    may be used to endorse or promote products derived from this software 
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE 
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE 
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR 
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, 
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE 
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 *********************************************************************************/

#include "xparameters.h"
#include <xil_types.h>
#include <math.h>
#include <stdio.h>
#include "xil_printf.h"

uint32_t* baseAddr = (uint32_t*) XPAR_PDM_AUDIO_0_S_AXI_BASEADDR;
uint32_t* speakerLBaseAddr =  (uint32_t*) XPAR_PDM_AUDIO_0_S_AXI_BASEADDR + 1024;

uint16_t sinArray[1024] = {
		0x8000,0x8647,0x8c8b,0x92c7,0x98f8,0x9f19,0xa527,0xab1e,0xb0fb,0xb6b9,0xbc56,0xc1cd,0xc71c,0xcc3f,0xd133,0xd5f4,0xda81,0xded6,0xe2f1,0xe6ce,0xea6c,0xedc9,0xf0e1,0xf3b5,0xf640,0xf883,0xfa7c,0xfc29,0xfd89,0xfe9c,0xff61,0xffd7,
		0xffff,0xffd7,0xff61,0xfe9c,0xfd89,0xfc29,0xfa7c,0xf883,0xf640,0xf3b5,0xf0e1,0xedc9,0xea6c,0xe6ce,0xe2f1,0xded6,0xda81,0xd5f4,0xd133,0xcc3f,0xc71c,0xc1cd,0xbc56,0xb6b9,0xb0fb,0xab1e,0xa527,0x9f19,0x98f8,0x92c7,0x8c8b,0x8647,
		0x8000,0x79b8,0x7374,0x6d38,0x6707,0x60e6,0x5ad8,0x54e1,0x4f04,0x4946,0x43a9,0x3e32,0x38e3,0x33c0,0x2ecc,0x2a0b,0x257e,0x2129,0x1d0e,0x1931,0x1593,0x1236,0xf1e,0xc4a,0x9bf,0x77c,0x583,0x3d6,0x276,0x163,0x9e,0x28,
		0x1,0x28,0x9e,0x163,0x276,0x3d6,0x583,0x77c,0x9bf,0xc4a,0xf1e,0x1236,0x1593,0x1931,0x1d0e,0x2129,0x257e,0x2a0b,0x2ecc,0x33c0,0x38e3,0x3e32,0x43a9,0x4946,0x4f04,0x54e1,0x5ad8,0x60e6,0x6707,0x6d38,0x7374,0x79b8,
		0x7fff,0x8647,0x8c8b,0x92c7,0x98f8,0x9f19,0xa527,0xab1e,0xb0fb,0xb6b9,0xbc56,0xc1cd,0xc71c,0xcc3f,0xd133,0xd5f4,0xda81,0xded6,0xe2f1,0xe6ce,0xea6c,0xedc9,0xf0e1,0xf3b5,0xf640,0xf883,0xfa7c,0xfc29,0xfd89,0xfe9c,0xff61,0xffd7,
		0xffff,0xffd7,0xff61,0xfe9c,0xfd89,0xfc29,0xfa7c,0xf883,0xf640,0xf3b5,0xf0e1,0xedc9,0xea6c,0xe6ce,0xe2f1,0xded6,0xda81,0xd5f4,0xd133,0xcc3f,0xc71c,0xc1cd,0xbc56,0xb6b9,0xb0fb,0xab1e,0xa527,0x9f19,0x98f8,0x92c7,0x8c8b,0x8647,
		0x8000,0x79b8,0x7374,0x6d38,0x6707,0x60e6,0x5ad8,0x54e1,0x4f04,0x4946,0x43a9,0x3e32,0x38e3,0x33c0,0x2ecc,0x2a0b,0x257e,0x2129,0x1d0e,0x1931,0x1593,0x1236,0xf1e,0xc4a,0x9bf,0x77c,0x583,0x3d6,0x276,0x163,0x9e,0x28,
		0x1,0x28,0x9e,0x163,0x276,0x3d6,0x583,0x77c,0x9bf,0xc4a,0xf1e,0x1236,0x1593,0x1931,0x1d0e,0x2129,0x257e,0x2a0b,0x2ecc,0x33c0,0x38e3,0x3e32,0x43a9,0x4946,0x4f04,0x54e1,0x5ad8,0x60e6,0x6707,0x6d38,0x7374,0x79b8,
		0x7fff,0x8647,0x8c8b,0x92c7,0x98f8,0x9f19,0xa527,0xab1e,0xb0fb,0xb6b9,0xbc56,0xc1cd,0xc71c,0xcc3f,0xd133,0xd5f4,0xda81,0xded6,0xe2f1,0xe6ce,0xea6c,0xedc9,0xf0e1,0xf3b5,0xf640,0xf883,0xfa7c,0xfc29,0xfd89,0xfe9c,0xff61,0xffd7,
		0xffff,0xffd7,0xff61,0xfe9c,0xfd89,0xfc29,0xfa7c,0xf883,0xf640,0xf3b5,0xf0e1,0xedc9,0xea6c,0xe6ce,0xe2f1,0xded6,0xda81,0xd5f4,0xd133,0xcc3f,0xc71c,0xc1cd,0xbc56,0xb6b9,0xb0fb,0xab1e,0xa527,0x9f19,0x98f8,0x92c7,0x8c8b,0x8647,
		0x8000,0x79b8,0x7374,0x6d38,0x6707,0x60e6,0x5ad8,0x54e1,0x4f04,0x4946,0x43a9,0x3e32,0x38e3,0x33c0,0x2ecc,0x2a0b,0x257e,0x2129,0x1d0e,0x1931,0x1593,0x1236,0xf1e,0xc4a,0x9bf,0x77c,0x583,0x3d6,0x276,0x163,0x9e,0x28,
		0x1,0x28,0x9e,0x163,0x276,0x3d6,0x583,0x77c,0x9bf,0xc4a,0xf1e,0x1236,0x1593,0x1931,0x1d0e,0x2129,0x257e,0x2a0b,0x2ecc,0x33c0,0x38e3,0x3e32,0x43a9,0x4946,0x4f04,0x54e1,0x5ad8,0x60e6,0x6707,0x6d38,0x7374,0x79b8,
		0x7fff,0x8647,0x8c8b,0x92c7,0x98f8,0x9f19,0xa527,0xab1e,0xb0fb,0xb6b9,0xbc56,0xc1cd,0xc71c,0xcc3f,0xd133,0xd5f4,0xda81,0xded6,0xe2f1,0xe6ce,0xea6c,0xedc9,0xf0e1,0xf3b5,0xf640,0xf883,0xfa7c,0xfc29,0xfd89,0xfe9c,0xff61,0xffd7,
		0xffff,0xffd7,0xff61,0xfe9c,0xfd89,0xfc29,0xfa7c,0xf883,0xf640,0xf3b5,0xf0e1,0xedc9,0xea6c,0xe6ce,0xe2f1,0xded6,0xda81,0xd5f4,0xd133,0xcc3f,0xc71c,0xc1cd,0xbc56,0xb6b9,0xb0fb,0xab1e,0xa527,0x9f19,0x98f8,0x92c7,0x8c8b,0x8647,
		0x8000,0x79b8,0x7374,0x6d38,0x6707,0x60e6,0x5ad8,0x54e1,0x4f04,0x4946,0x43a9,0x3e32,0x38e3,0x33c0,0x2ecc,0x2a0b,0x257e,0x2129,0x1d0e,0x1931,0x1593,0x1236,0xf1e,0xc4a,0x9bf,0x77c,0x583,0x3d6,0x276,0x163,0x9e,0x28,
		0x1,0x28,0x9e,0x163,0x276,0x3d6,0x583,0x77c,0x9bf,0xc4a,0xf1e,0x1236,0x1593,0x1931,0x1d0e,0x2129,0x257e,0x2a0b,0x2ecc,0x33c0,0x38e3,0x3e32,0x43a9,0x4946,0x4f04,0x54e1,0x5ad8,0x60e6,0x6707,0x6d38,0x7374,0x79b8,
		0x7fff,0x8647,0x8c8b,0x92c7,0x98f8,0x9f19,0xa527,0xab1e,0xb0fb,0xb6b9,0xbc56,0xc1cd,0xc71c,0xcc3f,0xd133,0xd5f4,0xda81,0xded6,0xe2f1,0xe6ce,0xea6c,0xedc9,0xf0e1,0xf3b5,0xf640,0xf883,0xfa7c,0xfc29,0xfd89,0xfe9c,0xff61,0xffd7,
		0xffff,0xffd7,0xff61,0xfe9c,0xfd89,0xfc29,0xfa7c,0xf883,0xf640,0xf3b5,0xf0e1,0xedc9,0xea6c,0xe6ce,0xe2f1,0xded6,0xda81,0xd5f4,0xd133,0xcc3f,0xc71c,0xc1cd,0xbc56,0xb6b9,0xb0fb,0xab1e,0xa527,0x9f19,0x98f8,0x92c7,0x8c8b,0x8647,
		0x8000,0x79b8,0x7374,0x6d38,0x6707,0x60e6,0x5ad8,0x54e1,0x4f04,0x4946,0x43a9,0x3e32,0x38e3,0x33c0,0x2ecc,0x2a0b,0x257e,0x2129,0x1d0e,0x1931,0x1593,0x1236,0xf1e,0xc4a,0x9bf,0x77c,0x583,0x3d6,0x276,0x163,0x9e,0x28,
		0x1,0x28,0x9e,0x163,0x276,0x3d6,0x583,0x77c,0x9bf,0xc4a,0xf1e,0x1236,0x1593,0x1931,0x1d0e,0x2129,0x257e,0x2a0b,0x2ecc,0x33c0,0x38e3,0x3e32,0x43a9,0x4946,0x4f04,0x54e1,0x5ad8,0x60e6,0x6707,0x6d38,0x7374,0x79b8,
		0x7fff,0x8647,0x8c8b,0x92c7,0x98f8,0x9f19,0xa527,0xab1e,0xb0fb,0xb6b9,0xbc56,0xc1cd,0xc71c,0xcc3f,0xd133,0xd5f4,0xda81,0xded6,0xe2f1,0xe6ce,0xea6c,0xedc9,0xf0e1,0xf3b5,0xf640,0xf883,0xfa7c,0xfc29,0xfd89,0xfe9c,0xff61,0xffd7,
		0xffff,0xffd7,0xff61,0xfe9c,0xfd89,0xfc29,0xfa7c,0xf883,0xf640,0xf3b5,0xf0e1,0xedc9,0xea6c,0xe6ce,0xe2f1,0xded6,0xda81,0xd5f4,0xd133,0xcc3f,0xc71c,0xc1cd,0xbc56,0xb6b9,0xb0fb,0xab1e,0xa527,0x9f19,0x98f8,0x92c7,0x8c8b,0x8647,
		0x8000,0x79b8,0x7374,0x6d38,0x6707,0x60e6,0x5ad8,0x54e1,0x4f04,0x4946,0x43a9,0x3e32,0x38e3,0x33c0,0x2ecc,0x2a0b,0x257e,0x2129,0x1d0e,0x1931,0x1593,0x1236,0xf1e,0xc4a,0x9bf,0x77c,0x583,0x3d6,0x276,0x163,0x9e,0x28,
		0x1,0x28,0x9e,0x163,0x276,0x3d6,0x583,0x77c,0x9bf,0xc4a,0xf1e,0x1236,0x1593,0x1931,0x1d0e,0x2129,0x257e,0x2a0b,0x2ecc,0x33c0,0x38e3,0x3e32,0x43a9,0x4946,0x4f04,0x54e1,0x5ad8,0x60e6,0x6707,0x6d38,0x7374,0x79b8,
		0x7fff,0x8647,0x8c8b,0x92c7,0x98f8,0x9f19,0xa527,0xab1e,0xb0fb,0xb6b9,0xbc56,0xc1cd,0xc71c,0xcc3f,0xd133,0xd5f4,0xda81,0xded6,0xe2f1,0xe6ce,0xea6c,0xedc9,0xf0e1,0xf3b5,0xf640,0xf883,0xfa7c,0xfc29,0xfd89,0xfe9c,0xff61,0xffd7,
		0xffff,0xffd7,0xff61,0xfe9c,0xfd89,0xfc29,0xfa7c,0xf883,0xf640,0xf3b5,0xf0e1,0xedc9,0xea6c,0xe6ce,0xe2f1,0xded6,0xda81,0xd5f4,0xd133,0xcc3f,0xc71c,0xc1cd,0xbc56,0xb6b9,0xb0fb,0xab1e,0xa527,0x9f19,0x98f8,0x92c7,0x8c8b,0x8647,
		0x7fff,0x79b8,0x7374,0x6d38,0x6707,0x60e6,0x5ad8,0x54e1,0x4f04,0x4946,0x43a9,0x3e32,0x38e3,0x33c0,0x2ecc,0x2a0b,0x257e,0x2129,0x1d0e,0x1931,0x1593,0x1236,0xf1e,0xc4a,0x9bf,0x77c,0x583,0x3d6,0x276,0x163,0x9e,0x28,
		0x1,0x28,0x9e,0x163,0x276,0x3d6,0x583,0x77c,0x9bf,0xc4a,0xf1e,0x1236,0x1593,0x1931,0x1d0e,0x2129,0x257e,0x2a0b,0x2ecc,0x33c0,0x38e3,0x3e32,0x43a9,0x4946,0x4f04,0x54e1,0x5ad8,0x60e6,0x6707,0x6d38,0x7374,0x79b8,
		0x7fff,0x8647,0x8c8b,0x92c7,0x98f8,0x9f19,0xa527,0xab1e,0xb0fb,0xb6b9,0xbc56,0xc1cd,0xc71c,0xcc3f,0xd133,0xd5f4,0xda81,0xded6,0xe2f1,0xe6ce,0xea6c,0xedc9,0xf0e1,0xf3b5,0xf640,0xf883,0xfa7c,0xfc29,0xfd89,0xfe9c,0xff61,0xffd7,
		0xffff,0xffd7,0xff61,0xfe9c,0xfd89,0xfc29,0xfa7c,0xf883,0xf640,0xf3b5,0xf0e1,0xedc9,0xea6c,0xe6ce,0xe2f1,0xded6,0xda81,0xd5f4,0xd133,0xcc3f,0xc71c,0xc1cd,0xbc56,0xb6b9,0xb0fb,0xab1e,0xa527,0x9f19,0x98f8,0x92c7,0x8c8b,0x8647,
		0x8000,0x79b8,0x7374,0x6d38,0x6707,0x60e6,0x5ad8,0x54e1,0x4f04,0x4946,0x43a9,0x3e32,0x38e3,0x33c0,0x2ecc,0x2a0b,0x257e,0x2129,0x1d0e,0x1931,0x1593,0x1236,0xf1e,0xc4a,0x9bf,0x77c,0x583,0x3d6,0x276,0x163,0x9e,0x28,
		0x1,0x28,0x9e,0x163,0x276,0x3d6,0x583,0x77c,0x9bf,0xc4a,0xf1e,0x1236,0x1593,0x1931,0x1d0e,0x2129,0x257e,0x2a0b,0x2ecc,0x33c0,0x38e3,0x3e32,0x43a9,0x4946,0x4f04,0x54e1,0x5ad8,0x60e6,0x6707,0x6d38,0x7374,0x79b8
};

// equivalent 440Hz,
void speaker_set_waveform(int loudness) {
	for(int i = 0; i < 1024; i++) {
		*(speakerLBaseAddr + i) = (uint32_t) (sinArray[i] / loudness);
	}
}

void speaker_start() {
	*(baseAddr) |= 0x01;
}

void speaker_stop() {
	*(baseAddr) &= ~0x01;
}

void mic_loopback() {
	*(baseAddr) |= 0x04;
	*(baseAddr + 1) |= 0x01;
}

void mic_noloopback() {
	*(baseAddr) &= ~0x04;
	*(baseAddr + 1) &= ~0x01;
}

int main() {
	char cmd;
	xil_printf("Speaker Test\r\n\n");

	xil_printf("Init waveform array...\r\n");
	speaker_set_waveform(1);

	while(1) {
		xil_printf("s - speaker test start\r\n");
		xil_printf("p - speaker test stop\r\n");
		xil_printf("l - loopback test\r\n");
		xil_printf("0 to 9 - set loudness\r\n");
		cmd = getchar();
		switch(cmd) {
		case 's':
			xil_printf("Start Speaker\r\n");
			speaker_start();
			break;
		case 'p':
			xil_printf("Stop Speaker\r\n");
			speaker_stop();
			mic_noloopback();
			break;
		case 'l':
			xil_printf("Mic Loopback Test\r\n");
			mic_loopback();
			speaker_start();
			break;
		default:
			if(cmd <= '9' && cmd >= '0') {
				speaker_stop();
				mic_noloopback();
				speaker_set_waveform(10 - (cmd - '0'));
			}
			break;
		}
	}
}
